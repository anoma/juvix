working-directory: ./../../../tests

tests:
  - name: shows-file-argument-for-autocompletion
    command:
      - juvix
      - format
      - --help
    stdout:
      contains:
        JUVIX_FILE
    exit-status: 0

  - name: format-formatted-file
    command:
      - juvix
      - format
      - positive/Format.juvix
    exit-status: 0
    stdout: ""

  - name: format-unformatted-file
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        cd $temp
        touch juvix.yaml
        echo "module Foo ;" >> Foo.juvix
        juvix format Foo.juvix
    stdout:
      contains: module Foo;
    exit-status: 1

  - name: format-unformatted-file-check-no-stdout
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        cd $temp
        touch juvix.yaml
        echo "module Foo ;" >> Foo.juvix
        juvix format --check Foo.juvix
    stdout: ""
    exit-status: 1

  - name: format-formatted-file-check-no-stdout
    command:
      - juvix
      - format
      - --check
      - positive/Format.juvix
    exit-status: 0
    stdout: ""

  - name: format-dir-with-all-formatted
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        touch $temp/juvix.yaml
        cp positive/Format.juvix $temp
        juvix format $temp
    stdout: ""
    exit-status: 0

  - name: format-dir-containing-unformatted
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        touch $temp/juvix.yaml
        cp positive/Format.juvix $temp
        cd $temp
        echo "module Foo ;" >> Foo.juvix
        juvix format $temp
    stdout:
      contains:
        "Foo.juvix"
    exit-status: 1

  - name: format-dir-containing-unformatted-check-no-stdout
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        touch $temp/juvix.yaml
        cp positive/Format.juvix $temp
        cd $temp
        echo "module Foo ;" >> Foo.juvix
        juvix format --check $temp
    stdout: ""
    exit-status: 1

  - name: format-dir-with-all-formatted-check-no-stdout
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        touch $temp/juvix.yaml
        cp positive/Format.juvix $temp
        juvix format --check $temp
    stdout: ""
    exit-status: 0

  - name: format-file-with-scope-error
    command:
      shell:
        - bash
      script: |
        temp=$(mktemp -d)
        trap 'rm -rf -- "$temp"' EXIT
        cd $temp
        echo "modul Bar;" > Foo.juvix
        juvix format Foo.juvix
    stderr:
      contains: "error"
    exit-status: 1

  - name: format-stdin
    command:
      - juvix
      - --stdin
      - format
      - positive/Format.juvix
    stdin: "module Format; open import Stdlib.Prelude; main : Nat; main := 5; "
    stdout:
      contains: |
        module Format;

        open import Stdlib.Prelude;

        main : Nat;
        main := 5;
    exit-status: 1

  - name: format-stdin-file-does-not-exist
    command:
      - juvix
      - --stdin
      - format
      - positive/NonExistingFormat.juvix
    stdin: "module Format; open import Stdlib.Prelude; main : Nat; main := 5; "
    stderr:
      contains: |
        positive/NonExistingFormat.juvix: openFile: does not exist (No such file or directory)
    exit-status: 1

  - name: format-stdin-module-name-not-file-name
    command:
      - juvix
      - --stdin
      - format
      - positive/Format.juvix
    stdin: "module OtherFormat; open import Stdlib.Prelude; main : Nat; main := 5; "
    stdout:
      contains: |
        module OtherFormat;

        open import Stdlib.Prelude;

        main : Nat;
        main := 5;
    exit-status: 1

  - name: format-stdin-no-file-name
    command:
      - juvix
      - --stdin
      - format
    stdin: "module OtherFormat; open import Stdlib.Prelude; main : Nat; main := 5; "
    stdout:
      contains: |
        module OtherFormat;

        open import Stdlib.Prelude;

        main : Nat;
        main := 5;
    exit-status: 1

  - name: format-no-stdin-no-file-name
    command:
      - juvix
      - format
    stdin: "module OtherFormat; open import Stdlib.Prelude; main : Nat; main := 5module OtherFormat; open import Stdlib.Prelude; main : Nat; main := 5;; "
    stdout:
      contains: juvix format error
    exit-status: 1
